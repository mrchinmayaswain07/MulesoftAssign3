<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
      xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
        http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd">

    <flow name="salesforce-upsert-impl">

        <logger level="INFO"
                message="[CorrelationId: #[correlationId]] Processing Product ID: #[payload.id]"/>

        <!-- Transform to Salesforce -->
        <ee:transform>
            <ee:message>
                <ee:set-payload><![CDATA[
%dw 2.0
output application/java
---
[
  {
    External_Id__c: payload.id as String,
    Name: payload.title,
    Category__c: payload.Category__c,
    Price__c: payload.price,
    Description__c: payload.description,
    Image_URL__c: payload.image,
    Is_Active__c: payload.Is_Active__c,
    Product_Type__c: payload.productType
  }
]
                ]]></ee:set-payload>
            </ee:message>
        </ee:transform>

        <try>

            <until-successful maxRetries="3"
                              millisBetweenRetries="3000">

                <salesforce:upsert config-ref="Salesforce_Config"
                                   objectType="External_Product__c"
                                   externalIdFieldName="External_Id__c"/>

            </until-successful>

            <logger level="INFO"
                    message="[CorrelationId: #[correlationId]] Product Synced Successfully."/>

        <error-handler>

            <on-error-propagate>
                <logger level="ERROR"
                        message="[CorrelationId: #[correlationId]] Failed after retries. Sending to DLQ."/>

               <vm:publish config-ref="VM_Config"
            queueName="product.sync.dlq"/>

            </on-error-propagate>

        </error-handler>

        </try>

    </flow>

</mule>
