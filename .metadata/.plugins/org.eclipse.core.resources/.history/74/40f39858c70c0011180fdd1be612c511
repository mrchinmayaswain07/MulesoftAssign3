<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
      xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
        http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd">

    <flow name="salesforce-upsert-impl">

        <logger level="INFO"
                message=" Processing Product"/>

        <!-- Transform to Salesforce -->
        <ee:transform>
            <ee:message>
                <ee:set-payload><![CDATA[
%dw 2.0
output application/java
---
[
  {
    External_Id__c: payload.id as String,
    Name:
      if (sizeOf(payload.title) > 80)
        (payload.title)[0 to 79]
      else
        payload.title,
    Category__c:
            if (payload.category == "electronics")
                "Electronics"
            else
                payload.category,
    Price__c: payload.price default 0,
    Description__c: payload.description default "",
    Image_URL__c: payload.image default "",
    Is_Active__c: (payload.price default 0) >= 20,
    Product_Type__c: payload.productType
  }
]
                ]]></ee:set-payload>
            </ee:message>
        </ee:transform>

        <try>

            <until-successful maxRetries="3"
                              millisBetweenRetries="3000">

                <salesforce:upsert config-ref="Salesforce_Config"
                                   objectType="External_Product__c"
                                   externalIdFieldName="External_Id__c"/>

            </until-successful>

            <ee:transform doc:name="Transform Message" doc:id="c2444015-415a-42e0-922e-f5608e976629" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    status: "SUCCESS",
    message: "Product Synced Successfully",
    id: payload[0].id default null
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>

        <error-handler>

            <on-error-propagate>
                <logger level="ERROR"
                        message=" Sending to DLQ."/>

               <vm:publish config-ref="VM_Config"
            queueName="product.sync.dlq" sendCorrelationId="AUTO"/>

            </on-error-propagate>

        </error-handler>

        </try>

    </flow>


</mule>
